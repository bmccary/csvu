#!/usr/bin/env python

if __name__ == '__main__':

    from csv import DictReader, DictWriter, Sniffer, excel, excel_tab
    from csvu import GrepFilter
    import sys
    import argparse
    from cStringIO import StringIO
    import re

    #
    # Command-line argument processing.
    #

    parser = argparse.ArgumentParser(description='CSVU grep is like GNU grep, but for CSV files.')

    parser.add_argument(
            '--negate',
            '-v', 
            default=True, 
            action='store_const', 
            const=False,
            help='Include only non-matches.'
        )

    parser.add_argument(
            '--dialect', 
            default='sniff', 
            choices=['sniff', 'excel', 'excel-tab'],
            help='''The *sniff* detects the dialect, 
                    *excel* dialect uses commas, 
                    *excel-tab* uses tabs.
                    Note that *sniff* will load the
                    entire file into memory, so for large
                    files it may be better to explicitly
                    specify the dialect.
                    '''
        )

    parser.add_argument(
            'column', 
            type=str,
            help='The column to grep upon.'
        )

    parser.add_argument(
            'regex', 
            type=str,
            help='The regular expression (see the python re module).'
        )

    parser.add_argument(
            'file', 
            type=str, 
            nargs='?', 
            default='-',
            help='The CSV file to grep, defaults to STDIN'
        )

    args = parser.parse_args()

    #
    # The CSV file to grep.
    #

    f = sys.stdin

    if args.file != '-':
        f = open(args.file, 'r')

    #
    # The dialect of CSV file.
    #

    dialect = None

    if args.dialect == 'sniff':
        # reads the entire file into memory.
        f = StringIO(f.read())
        sample = f.read()
        f.reset()
        dialect = Sniffer().sniff(sample)
    elif args.dialect == 'excel':
        dialect = excel
    elif args.dialect == 'excel-tab':
        dialect = excel_tab

    #
    # Sanity checks.
    #

    reader = DictReader(f, dialect=dialect)

    if not args.column in reader.fieldnames:
        parser.error("Column '{}' does not appear in the data.".format(args.column))

    try:
        regex = re.compile(args.regex)
    except:
        parser.error("Cannot compile regex '{}', see python *re* module.".format(args.regex))

    #
    # The actual computation.
    #    

    grep   = GrepFilter(col=args.column, include=args.negate, regex=args.regex)
    writer = DictWriter(f=sys.stdout, fieldnames=reader.fieldnames, dialect=dialect)

    writer.writeheader()
    writer.writerows(row for row in reader if grep(row))

