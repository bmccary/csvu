#!/usr/bin/env python -u

if __name__ == '__main__':

    from csv import writer, excel, excel_tab
    from csvu import xlsx_row_g
    import sys
    import argparse
    from cStringIO import StringIO

    #
    # Command-line argument processing.
    #
    
    parser = argparse.ArgumentParser(
            description='CSVC xlsx-to-csv converts a sheet of an XLSX file to CSV.'
        )

    parser.add_argument(
            'file', 
            nargs='?', 
            default='-', 
            type=str,
            help='The XLSX file.'
        )

    def nonnegative_int(x):
        try:
            y = int(x)
            if y < 0:
                raise None
            return y
        except:
            m = "Not a nonnegative integer: '{}'".format(x)
            raise argparse.ArgumentTypeError(m)

    parser.add_argument(
            '--sheet', 
            default=0, 
            type=nonnegative_int,
            help='The sheet of the XLSX file to convert to CSV.'
        )

    parser.add_argument(
            '--dialect1', 
            default='excel',
            choices=['excel', 'excel-tab',],
            type=str,
            help='The CSV dialect to use in the output file.'
        )

    args = parser.parse_args()

    #
    # The XLSX file to open.
    #

    f = None

    if args.file == '-':
        # OpenPYXL needs random access to the XLSX
        # file, therefore the entire file needs to
        # be read out of STDIN and buffered. StringIO 
        # buffers it in memory.
        f = StringIO(sys.stdin.read())
        f.reset()
    else:
        f = open(args.file, 'rb')

    #
    # The actual computation.
    #

    w = writer(sys.stdout, dialect=args.dialect1)

    try:
        w.writerows(xlsx_row_g(f, sheet=args.sheet))
    except Exception as e:
        parser.error(e)

